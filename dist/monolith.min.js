!function(){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}angular.module("fimderAppModule",["viewsModule","searchBoxModule","searchResultsModule","movieDetailsModule","cachingModule"]),angular.module("fimderAppModule").config(["$interpolateProvider","$compileProvider",function($interpolateProvider,$compileProvider){$interpolateProvider.startSymbol("[["),$interpolateProvider.endSymbol("]]"),$compileProvider.debugInfoEnabled(!1),$compileProvider.commentDirectivesEnabled(!1),$compileProvider.cssClassDirectivesEnabled(!1)}]),angular.module("assertModule",[]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),AssertService=function(){function AssertService(){_classCallCheck(this,AssertService)}return _createClass(AssertService,[{key:"isTrue",value:function isTrue(expression){if(expression!==!0)throw new Error(this._getText("true expression"))}},{key:"isFalse",value:function isFalse(expression){if(expression!==!1)throw new Error(this._getText("false expression"))}},{key:"isDefined",value:function isDefined(value){if(void 0===value)throw new Error(this._getText("defined value"))}},{key:"isNull",value:function isNull(value){if(null!==value)throw new Error(this._getTextWithValue("null",value))}},{key:"isBool",value:function isBool(value){if(!_.isBoolean(value))throw new Error(this._getTextWithValue("boolean",value))}},{key:"isNumber",value:function isNumber(value){if(!_.isNumber(value))throw new Error(this._getTextWithValue("number",value))}},{key:"isInteger",value:function isInteger(value){if(!Number.isInteger(value))throw new Error(this._getTextWithValue("integer",value))}},{key:"isString",value:function isString(value){if(!_.isString(value))throw new Error(this._getTextWithValue("string",value))}},{key:"isPlainObject",value:function isPlainObject(value){if(!_.isPlainObject(value))throw new Error(this._getTextWithValue("plain object",value))}},{key:"isArray",value:function isArray(value){if(!_.isArray(value))throw new Error(this._getTextWithValue("array",value))}},{key:"isFunction",value:function isFunction(value){if(!_.isFunction(value))throw new Error(this._getTextWithValue("function",value))}},{key:"_getText",value:function _getText(expectedText){return"Assertion failed: expected "+expectedText}},{key:"_getTextWithValue",value:function _getTextWithValue(expectedText,value){return this._getText(expectedText)+", but got {"+(void 0===value?"undefined":_typeof(value))+"} "+value+" instead"}}]),AssertService}();angular.module("assertModule").service("assert",AssertService),angular.module("cachingModule",["angular-cache"]),angular.module("cachingModule").run(["cachingEnabler",angular.noop]);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),CachingEnablerService=function(){function CachingEnablerService($http,CacheFactory){_classCallCheck(this,CachingEnablerService),$http.defaults.cache=CacheFactory("defaultCache",{deleteOnExpire:"passive",storageMode:"localStorage",storagePrefix:"fimder.",maxAge:36e5}),console.info("localStorage cache enabled"),this.isEnabled=!0}return _createClass(CachingEnablerService,null,[{key:"initClass",value:function initClass(){CachingEnablerService.$inject=["$http","CacheFactory"]}}]),CachingEnablerService}();CachingEnablerService.initClass(),angular.module("cachingModule").service("cachingEnabler",CachingEnablerService),angular.module("httpRetrierModule",["assertModule"]);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),HttpRetrierService=function(){function HttpRetrierService($q,$http,$timeout,assert){_classCallCheck(this,HttpRetrierService),this._$q=$q,this._$http=$http,this._$timeout=$timeout,this._assert=assert,this._retriers={},this.rejectReasons=Object.freeze({cancel:0,overLimit:1}),this._uniqueIdCounter=0}return _createClass(HttpRetrierService,null,[{key:"initClass",value:function initClass(){HttpRetrierService.intervalTime=2e3,HttpRetrierService.defaultLimit=10,HttpRetrierService.$inject=["$q","$http","$timeout","assert"]}}]),_createClass(HttpRetrierService,[{key:"runGet",value:function runGet(url){var limit=arguments.length>1&&void 0!==arguments[1]?arguments[1]:HttpRetrierService.defaultLimit;return this._assert.isString(url),this._assert.isInteger(limit),this._run("get",url,limit)}},{key:"_run",value:function _run(method,url,limit){var retrier=this._createRetrier({method:method,url:url,cache:!0},limit);return this._retry(retrier),{promise:retrier.deferred.promise,cancel:this._cancelRetrier.bind(this,retrier.id)}}},{key:"_destroyRetrier",value:function _destroyRetrier(retrierId){delete this._retriers[retrierId]}},{key:"_createRetrier",value:function _createRetrier(httpConfig,limit){(limit<=0||limit>=16)&&(console.warn("You want limit to be "+limit+", really? Lmftfy."),limit=HttpRetrierService.defaultLimit);var retrierId=this._getUniqueId();return this._retriers[retrierId]={id:retrierId,httpConfig:httpConfig,count:0,limit:limit,deferred:this._$q.defer(),timeoutId:null},this._retriers[retrierId]}},{key:"_cancelRetrier",value:function _cancelRetrier(retrierId){this._retriers[retrierId]&&(this._retriers[retrierId].deferred.reject(this.rejectReasons.cancel),this._destroyRetrier(retrierId))}},{key:"_getUniqueId",value:function _getUniqueId(){return this._uniqueIdCounter++,"rtrr-"+this._uniqueIdCounter.toString(36)}},{key:"_retry",value:function _retry(retrier){retrier.timeoutId=this._$timeout(this._doHttpRequest.bind(this,retrier),HttpRetrierService.intervalTime*retrier.count,!1),retrier.count++}},{key:"_doHttpRequest",value:function _doHttpRequest(retrier){this._$http(retrier.httpConfig).then(this._onHttpRequestSuccess.bind(this,retrier),this._onHttpRequestError.bind(this,retrier))}},{key:"_onHttpRequestSuccess",value:function _onHttpRequestSuccess(retrier,response){retrier.deferred.resolve(response),this._destroyRetrier(retrier.id)}},{key:"_onHttpRequestError",value:function _onHttpRequestError(retrier,response){void 0!==this._retriers[retrier.id]&&(retrier.deferred.notify({response:response,count:retrier.count}),retrier.count>=retrier.limit?(retrier.deferred.reject(this.rejectReasons.overLimit),this._destroyRetrier(retrier.id)):this._retry(retrier))}}]),HttpRetrierService}();HttpRetrierService.initClass(),angular.module("httpRetrierModule").service("httpRetrier",HttpRetrierService),angular.module("movieDetailsModule",["assertModule","routesModule","moviesFetcherModule"]);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();angular.module("movieDetailsModule").factory("Movie",["assert","votesHumanizer",function(assert,votesHumanizer){var MovieModel=function(){function MovieModel(movieData){_classCallCheck(this,MovieModel),this._verifyAllRequiredProperties(movieData),this.id=movieData.imdbID,this.title=movieData.Title,this._setOptionalText("releaseDate",movieData.Released),this._setOptionalText("runtime",movieData.Runtime),this._setOptionalText("plot",movieData.Plot),this._setOptionalText("awards",movieData.Awards),this._setOptionalText("poster",movieData.Poster),this._setOptionalText("rating",movieData.imdbRating),this._setOptionalText("ratingVotes",movieData.imdbVotes),this._setOptionalArray("genres",movieData.Genre),this._setOptionalArray("directors",movieData.Director),this._setOptionalArray("writers",movieData.Writer),this._setOptionalArray("actors",movieData.Actors),this._setOptionalArray("languages",movieData.Language),this._setOptionalArray("countries",movieData.Country),this.ratingVotes&&(this.ratingVotes=votesHumanizer.getHumanized(this.ratingVotes))}return _createClass(MovieModel,null,[{key:"initClass",value:function initClass(){MovieModel.notAvailableProprety="N/A",MovieModel.requiredType="movie",MovieModel.requiredProperties=["imdbID","Title"]}}]),_createClass(MovieModel,[{key:"_isUsefulData",value:function _isUsefulData(data){return data&&data!==MovieModel.notAvailableProprety}},{key:"_setOptionalText",value:function _setOptionalText(propertyName,data){this._isUsefulData(data)&&(this[propertyName]=data)}},{key:"_setOptionalArray",value:function _setOptionalArray(propertyName,data){this._isUsefulData(data)&&(this[propertyName]=Array.from(new Set(data.split(", "))))}},{key:"_verifyAllRequiredProperties",value:function _verifyAllRequiredProperties(movieData){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=MovieModel.requiredProperties[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var propertyName=_step.value;assert.isString(movieData[propertyName])}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}assert.isTrue(movieData.Type===MovieModel.requiredType)}}]),MovieModel}();return MovieModel.initClass(),MovieModel}]);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),MovieDetailsController=function(){function MovieDetailsController(Movie,currentRoute,routesConfig,moviesFetcher,moviesFetcherConfig,assert){_classCallCheck(this,MovieDetailsController),this._Movie=Movie,this._currentRoute=currentRoute,this._routesConfig=routesConfig,this._moviesFetcher=moviesFetcher,this._moviesFetcherConfig=moviesFetcherConfig,this._assert=assert,this._lastSearchPhrase="",this.movie={},this.message=null,this.isDetailsVisible=!1,this.isSpinnerVisible=!1,this.isMessageVisible=!1,this._currentRoute.registerRouteObserver(this._onRouteChange.bind(this))}return _createClass(MovieDetailsController,null,[{key:"initClass",value:function initClass(){MovieDetailsController.$inject=["Movie","currentRoute","routesConfig","moviesFetcher","moviesFetcherConfig","assert"]}}]),_createClass(MovieDetailsController,[{key:"openSearch",value:function openSearch(){this._clearMovie(),this._hideAll(),this._currentRoute.setToSearch(this._lastSearchPhrase)}},{key:"_onRouteChange",value:function _onRouteChange(){var route=this._currentRoute.get();switch(route.routeId){case this._routesConfig.routes.movie:"string"==typeof route.params.movieId&&this._fetchMovieData(route.params.movieId);break;case this._routesConfig.routes.search:"string"==typeof route.params.searchPhrase&&(this._lastSearchPhrase=route.params.searchPhrase);break;default:console.warn('Unknown route "'+route.routeId+'"!')}}},{key:"_fetchMovieData",value:function _fetchMovieData(movieId){this._clearMovie(),this._showSpinner(),this._cancelRetrierIfNecessary(),this._retrier=this._moviesFetcher.fetchMovieById(movieId),this._retrier.promise.then(this._fetchMoviesSuccess.bind(this),this._fetchMoviesError.bind(this),this._fetchMoviesNotify.bind(this))}},{key:"_fetchMoviesSuccess",value:function _fetchMoviesSuccess(response){this._interpretMovieData(response.data)}},{key:"_fetchMoviesError",value:function _fetchMoviesError(errorReason){1===errorReason&&this._showMessage(this._moviesFetcherConfig.messages.overLimit)}},{key:"_fetchMoviesNotify",value:function _fetchMoviesNotify(){console.warn(this._moviesFetcherConfig.messages.retrying)}},{key:"_cancelRetrierIfNecessary",value:function _cancelRetrierIfNecessary(){void 0!==this._retrier&&(this._retrier.cancel(),delete this._retrier)}},{key:"_interpretMovieData",value:function _interpretMovieData(movieData){switch(movieData.Response){case"True":this.movie=new this._Movie(movieData),this._showDetails();break;case"False":this._showMessage(movieData.Error);break;default:this._showMessage(this._moviesFetcherConfig.unknownApiResponse)}}},{key:"_clearMovie",value:function _clearMovie(){this.movie={}}},{key:"_hideAll",value:function _hideAll(){this.isDetailsVisible=!1,this.isSpinnerVisible=!1,this.isMessageVisible=!1,this.message=null}},{key:"_showDetails",value:function _showDetails(){this._hideAll(),this.isDetailsVisible=!0}},{key:"_showSpinner",value:function _showSpinner(){this._hideAll(),this.isSpinnerVisible=!0}},{key:"_showMessage",value:function _showMessage(message){this._assert.isString(message),this._hideAll(),this.message=message,this.isMessageVisible=!0}}]),MovieDetailsController}();MovieDetailsController.initClass(),angular.module("movieDetailsModule").controller("movieDetailsCtrl",MovieDetailsController);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),VotesHumanizerService=function(){function VotesHumanizerService(assert){_classCallCheck(this,VotesHumanizerService),this._assert=assert}return _createClass(VotesHumanizerService,null,[{key:"initClass",value:function initClass(){VotesHumanizerService.$inject=["assert"]}}]),_createClass(VotesHumanizerService,[{key:"getHumanized",value:function getHumanized(votes){this._assert.isString(votes),this._assert.isTrue(0!==votes.length);var votesNumber=parseInt(votes.split(",").join(""),10);this._assert.isInteger(votesNumber);for(var kCount=0;votesNumber>=1e3;)votesNumber/=1e3,kCount++;var votesString=parseFloat(votesNumber.toFixed(1)).toString();return votesString+="k".repeat(kCount)}}]),VotesHumanizerService}();VotesHumanizerService.initClass(),angular.module("movieDetailsModule").service("votesHumanizer",VotesHumanizerService),angular.module("moviesFetcherModule",["httpRetrierModule","assertModule"]);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),MoviesFetcherService=function(){function MoviesFetcherService(httpRetrier,assert,$window){_classCallCheck(this,MoviesFetcherService),this._httpRetrier=httpRetrier,this._assert=assert,this._$window=$window}return _createClass(MoviesFetcherService,null,[{key:"initClass",value:function initClass(){MoviesFetcherService.apiUrl="http://www.omdbapi.com/?r=json&type=movie",MoviesFetcherService.retryLimit=3,MoviesFetcherService.$inject=["httpRetrier","assert","$window"]}}]),_createClass(MoviesFetcherService,[{key:"fetchMoviesBySearch",value:function fetchMoviesBySearch(searchPhrase){var page=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this._assert.isString(searchPhrase),this._httpRetrier.runGet(this._getSearchUrl(searchPhrase,page),MoviesFetcherService.retryLimit)}},{key:"_getSearchUrl",value:function _getSearchUrl(searchPhrase,page){var searchUrl=MoviesFetcherService.apiUrl;return searchUrl+="&s="+this._$window.encodeURIComponent(searchPhrase),searchUrl+="&page="+page}},{key:"fetchMovieById",value:function fetchMovieById(movieId){return this._assert.isString(movieId),this._httpRetrier.runGet(this._getMovieIdUrl(movieId),MoviesFetcherService.retryLimit)}},{key:"_getMovieIdUrl",value:function _getMovieIdUrl(movieId){var searchUrl=MoviesFetcherService.apiUrl;return searchUrl+="&plot=full&i=",searchUrl+=this._$window.encodeURIComponent(movieId)}}]),MoviesFetcherService}();MoviesFetcherService.initClass(),angular.module("moviesFetcherModule").service("moviesFetcher",MoviesFetcherService),angular.module("moviesFetcherModule").constant("moviesFetcherConfig",{messages:{unknownApiResponse:"Unknown API response, sorry!",overLimit:"Tried multiple times, but could not connect to API, sorry!",retrying:"Some problems with getting data, retrying!"}}),angular.module("observableModule",[]);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),ObservableModel=function(){function ObservableModel(){_classCallCheck(this,ObservableModel),this._observers=[],this._amountOfObservers=0,this._observersToRemove=[],this._amountToRemove=0,this._stateObservers=[],this._isActive=!1}return _createClass(ObservableModel,[{key:"_createCancelFunction",value:function _createCancelFunction(observerToCancel,afterCancelCallback){return function(){afterCancelCallback(observerToCancel),observerToCancel=null,afterCancelCallback=null}}},{key:"_afterCancel",value:function _afterCancel(observerToRemove){this._amountToRemove=this._observersToRemove.push(observerToRemove)}},{key:"_cleanRemovedObservers",value:function _cleanRemovedObservers(){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=this._observersToRemove[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var observerToRemove=_step.value,indexOf=this._observers.indexOf(observerToRemove);indexOf!==-1&&this._observers.splice(indexOf,1)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}this._amountOfObservers=this._observers.length,this._amountToRemove=0,this._observersToRemove.length=0,this._updateState(this._amountOfObservers>0)}},{key:"_updateState",value:function _updateState(newActiveState){if(this._isActive!==newActiveState){this._isActive=newActiveState;var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=this._stateObservers[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){(0,_step2.value)(this._isActive)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}}},{key:"register",value:function register(newObserver){return this._amountOfObservers=this._observers.push(newObserver),this._updateState(!0),this._createCancelFunction(newObserver,this._afterCancel.bind(this))}},{key:"notify",value:function notify(){if(0!==this._amountToRemove&&this._cleanRemovedObservers(),this._isActive){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];if(1===this._amountOfObservers)return void this._observers[0].apply(null,args);var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=this._observers[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){_step3.value.apply(null,args)}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}}}},{key:"onStateChange",value:function onStateChange(stateObserver){return this._stateObservers.push(stateObserver)}}]),ObservableModel}();angular.module("observableModule").factory("Observable",function(){return ObservableModel}),angular.module("routesModule",["ngRoute","assertModule","observableModule"]);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),CurrentRouteService=function(){function CurrentRouteService($rootScope,$route,$location,assert,routesConfig,Observable){_classCallCheck(this,CurrentRouteService),this._$route=$route,this._$location=$location,this._assert=assert,this._routesConfig=routesConfig,this._routeObservable=new Observable,$rootScope.$on("$routeChangeSuccess",this._onRouteChange.bind(this))}return _createClass(CurrentRouteService,null,[{key:"initClass",value:function initClass(){CurrentRouteService.$inject=["$rootScope","$route","$location","assert","routesConfig","Observable"]}}]),_createClass(CurrentRouteService,[{key:"_onRouteChange",value:function _onRouteChange(){this._routeObservable.notify()}},{key:"registerRouteObserver",value:function registerRouteObserver(observer){return this._routeObservable.register(observer)}},{key:"setToMovie",value:function setToMovie(movieId){this._assert.isString(movieId),this._$location.path(this._routesConfig.routes.movie+"/"+movieId)}},{key:"setToSearch",value:function setToSearch(){var searchPhrase=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this._assert.isString(searchPhrase),this._$location.path(this._routesConfig.routes.search+"/"+searchPhrase)}},{key:"get",value:function get(){return this._getRouteFromRouteData(this._$route.current)}},{key:"_getRouteFromRouteData",value:function _getRouteFromRouteData(routeData){return void 0===routeData?(console.warn("Tried to get route before it was set!"),{routeId:null,params:null}):{routeId:routeData.locals.routeId,params:routeData.params}}}]),CurrentRouteService}();CurrentRouteService.initClass(),angular.module("routesModule").service("currentRoute",CurrentRouteService),angular.module("routesModule").constant("routesConfig",{routes:{movie:"movie",search:"search"}}),angular.module("routesModule").config(["$routeProvider","$locationProvider","routesConfig",function($routeProvider,$locationProvider,routesConfig){$routeProvider.when("/"+routesConfig.routes.movie+"/:movieId",{resolve:{routeId:[function(){return routesConfig.routes.movie}]}}).when("/"+routesConfig.routes.search+"/:searchPhrase?",{resolve:{routeId:[function(){return routesConfig.routes.search}]}}).otherwise({redirectTo:"/"+routesConfig.routes.search+"/"}),$locationProvider.html5Mode(!1)}]),angular.module("searchBoxModule",["observableModule","routesModule"]);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),SearchBoxController=function(){function SearchBoxController($scope,$element,$timeout,currentRoute,routesConfig){_classCallCheck(this,SearchBoxController),this._$scope=$scope,this._$timeout=$timeout,this._currentRoute=currentRoute,this._routesConfig=routesConfig,this._inputEl=$element[0].querySelector(SearchBoxController.inputSelector),this.inputValue="",this._lastAppliedInputValue=null,this._isVirgin=!0,this._applyInputValueDebounced=_.debounce(this._applyInputValue.bind(this),SearchBoxController.debounceTime),this._currentRoute.registerRouteObserver(this._onRouteChange.bind(this))}return _createClass(SearchBoxController,null,[{key:"initClass",value:function initClass(){SearchBoxController.debounceTime=500,SearchBoxController.enterKey=13,SearchBoxController.inputSelector="[js-searchBox-input]",SearchBoxController.$inject=["$scope","$element","$timeout","currentRoute","routesConfig"]}}]),_createClass(SearchBoxController,[{key:"_onRouteChange",value:function _onRouteChange(){var route=this._currentRoute.get();route.routeId===this._routesConfig.routes.search&&(this._isVirgin&&(this.inputValue=route.params.searchPhrase),this._focusOnInput()),route.routeId===this._routesConfig.routes.movie&&this._applyInputValueDebounced.cancel(),this._isVirgin&&(this._isVirgin=!1)}},{key:"_applyInputValue",value:function _applyInputValue(){this._applyInputValueDebounced.cancel(),this._lastAppliedInputValue!==this.inputValue&&(this._lastAppliedInputValue=this.inputValue,this._$scope.$applyAsync(this._currentRoute.setToSearch.bind(this._currentRoute,this.inputValue)))}},{key:"_focusOnInput",value:function _focusOnInput(){var _this=this;this._$timeout(function(){_this._inputEl.focus()},1,!1)}},{key:"onInputValueChange",value:function onInputValueChange(){this._applyInputValueDebounced()}},{key:"onInputKeypress",value:function onInputKeypress(e){e.which===SearchBoxController.enterKey&&this._applyInputValue()}},{key:"clear",value:function clear(){this.inputValue="",this._applyInputValue(),this._focusOnInput()}}]),SearchBoxController}();SearchBoxController.initClass(),angular.module("searchBoxModule").controller("searchBoxCtrl",SearchBoxController),angular.module("searchResultsModule",["assertModule","routesModule","moviesFetcherModule","observableModule"]),angular.module("searchResultsModule").run(["searchResultsRepository",angular.noop]);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),LoadMoreController=function(){function LoadMoreController(searchResultsRepository){_classCallCheck(this,LoadMoreController),this._searchResultsRepository=searchResultsRepository,this.isVisible=!1,this._searchResultsRepository.registerDataObserver(this._onSearchResultsDataChange.bind(this))}return _createClass(LoadMoreController,null,[{key:"initClass",value:function initClass(){LoadMoreController.$inject=["searchResultsRepository"]}}]),_createClass(LoadMoreController,[{key:"trigger",value:function trigger(){this._searchResultsRepository.loadMoreResults()}},{key:"_onSearchResultsDataChange",value:function _onSearchResultsDataChange(data){this.isVisible=data.totalResults>data.results.length&&!data.isFetchPending}}]),LoadMoreController}();LoadMoreController.initClass(),angular.module("searchResultsModule").controller("loadMoreCtrl",LoadMoreController);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();angular.module("searchResultsModule").factory("SearchResult",["assert","currentRoute",function(assert,currentRoute){return function(){function SearchResultModel(movieData){_classCallCheck(this,SearchResultModel),assert.isString(movieData.Title),assert.isString(movieData.Year),assert.isString(movieData.imdbID),this.title=movieData.Title,this.year=movieData.Year,this.movieId=movieData.imdbID}
return _createClass(SearchResultModel,[{key:"open",value:function open(){currentRoute.setToMovie(this.movieId)}}]),SearchResultModel}()}]);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),SearchResultsController=function(){function SearchResultsController(searchResultsRepository){_classCallCheck(this,SearchResultsController),this._searchResultsRepository=searchResultsRepository,this.results=[],this.message=null,this.isListVisible=!1,this.isSpinnerVisible=!1,this.isMessageVisible=!1,this._searchResultsRepository.registerDataObserver(this._onSearchResultsDataChange.bind(this))}return _createClass(SearchResultsController,null,[{key:"initClass",value:function initClass(){SearchResultsController.emptyMessage="Hi! Please type movie title above :-)",SearchResultsController.$inject=["searchResultsRepository"]}}]),_createClass(SearchResultsController,[{key:"openMovie",value:function openMovie(result){result.open()}},{key:"_onSearchResultsDataChange",value:function _onSearchResultsDataChange(data){this.results=_.uniqBy(data.results,"movieId"),this.isSpinnerVisible=data.isFetchPending,data.error?this.message=data.error:0!==this.results.length||data.isFetchPending?delete this.message:this.message=SearchResultsController.emptyMessage}}]),SearchResultsController}();SearchResultsController.initClass(),angular.module("searchResultsModule").controller("searchResultsCtrl",SearchResultsController);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),SearchResultsRepositoryService=function(){function SearchResultsRepositoryService(SearchResult,currentRoute,routesConfig,moviesFetcher,moviesFetcherConfig,assert,Observable){_classCallCheck(this,SearchResultsRepositoryService),this._SearchResult=SearchResult,this._currentRoute=currentRoute,this._routesConfig=routesConfig,this._moviesFetcher=moviesFetcher,this._moviesFetcherConfig=moviesFetcherConfig,this._assert=assert,this._currentSearchPhrase=null,this._results=[],this._totalResults=0,this._error=null,this._isFetchPending=!1,this._currentRoute.registerRouteObserver(this._onRouteChange.bind(this)),this._dataObservable=new Observable}return _createClass(SearchResultsRepositoryService,null,[{key:"initClass",value:function initClass(){SearchResultsRepositoryService.minSearchChars=3,SearchResultsRepositoryService.resultsPerPage=10,SearchResultsRepositoryService.$inject=["SearchResult","currentRoute","routesConfig","moviesFetcher","moviesFetcherConfig","assert","Observable"]}}]),_createClass(SearchResultsRepositoryService,[{key:"loadMoreResults",value:function loadMoreResults(){this._fetchMoreData()}},{key:"_notifyDataChange",value:function _notifyDataChange(){this._dataObservable.notify({results:this._results,totalResults:this._totalResults,isFetchPending:this._isFetchPending,error:this._error})}},{key:"registerDataObserver",value:function registerDataObserver(observer){return this._dataObservable.register(observer)}},{key:"_onRouteChange",value:function _onRouteChange(){var route=this._currentRoute.get();route.routeId===this._routesConfig.routes.search&&this._currentSearchPhrase!==route.params.searchPhrase&&(this._currentSearchPhrase=route.params.searchPhrase,this._stopAndResetData(),"string"==typeof route.params.searchPhrase&&this._currentSearchPhrase.length>=SearchResultsRepositoryService.minSearchChars&&this._fetchMoreData())}},{key:"_stopAndResetData",value:function _stopAndResetData(){this._results=[],this._totalResults=0,this._removeError(),this._cancelPendingFetch(),this._notifyDataChange()}},{key:"_fetchMoreData",value:function _fetchMoreData(){this._isFetchPending=!0,this._retrier=this._moviesFetcher.fetchMoviesBySearch(this._currentSearchPhrase,this._getCurrentSearchPage()),this._retrier.promise.then(this._fetchMoviesSuccess.bind(this),this._fetchMoviesError.bind(this),this._fetchMoviesNotify.bind(this)),this._notifyDataChange()}},{key:"_cancelPendingFetch",value:function _cancelPendingFetch(){this._isFetchPending=!1,void 0!==this._retrier&&(this._retrier.cancel(),delete this._retrier)}},{key:"_fetchMoviesSuccess",value:function _fetchMoviesSuccess(response){this._isFetchPending=!1,this._interpretResults(response.data),this._notifyDataChange()}},{key:"_fetchMoviesError",value:function _fetchMoviesError(errorReason){this._isFetchPending=!1,1===errorReason&&this._setError(this._moviesFetcherConfig.messages.overLimit),this._notifyDataChange()}},{key:"_fetchMoviesNotify",value:function _fetchMoviesNotify(){console.warn(this._moviesFetcherConfig.messages.retrying)}},{key:"_getCurrentSearchPage",value:function _getCurrentSearchPage(){return this._results.length/SearchResultsRepositoryService.resultsPerPage+1}},{key:"_interpretResults",value:function _interpretResults(resultsData){switch(resultsData.Response){case"True":this._addMoreResults(resultsData.Search,resultsData.totalResults),this._removeError();break;case"False":this._setError(resultsData.Error);break;default:this._setError(this._moviesFetcherConfig.messages.unknownApiResponse)}}},{key:"_addMoreResults",value:function _addMoreResults(moviesArray,totalResults){this._assert.isArray(moviesArray);var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=moviesArray[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var movie=_step.value;this._results.push(new this._SearchResult(movie))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}var totalResultsNumber=parseInt(totalResults,10);this._assert.isInteger(totalResultsNumber),this._totalResults=totalResultsNumber}},{key:"_setError",value:function _setError(errorMessage){this._error=errorMessage}},{key:"_removeError",value:function _removeError(){this._error=null}}]),SearchResultsRepositoryService}();SearchResultsRepositoryService.initClass(),angular.module("searchResultsModule").service("searchResultsRepository",SearchResultsRepositoryService),angular.module("viewsModule",["routesModule"]);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),ViewsController=function(){function ViewsController(currentRoute,routesConfig){_classCallCheck(this,ViewsController),this._currentRoute=currentRoute,this._routesConfig=routesConfig,this.isSearchViewVisible=!1,this.isMovieViewVisible=!1,this._currentRoute.registerRouteObserver(this._onRouteChange.bind(this))}return _createClass(ViewsController,null,[{key:"initClass",value:function initClass(){ViewsController.$inject=["currentRoute","routesConfig"]}}]),_createClass(ViewsController,[{key:"_onRouteChange",value:function _onRouteChange(){var route=this._currentRoute.get();switch(this._hideAllViews(),route.routeId){case this._routesConfig.routes.search:this.isSearchViewVisible=!0;break;case this._routesConfig.routes.movie:this.isMovieViewVisible=!0;break;default:console.error("Unknown route: "+route.routeId)}}},{key:"_hideAllViews",value:function _hideAllViews(){this.isSearchViewVisible=!1,this.isMovieViewVisible=!1}}]),ViewsController}();ViewsController.initClass(),angular.module("viewsModule").controller("viewsCtrl",ViewsController)}();